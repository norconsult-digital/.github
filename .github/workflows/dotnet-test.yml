name: .NET Test

permissions:
  id-token: write
  contents: read
  packages: read  

on:
  workflow_call:
    inputs:
      environment:
        required: false
        type: string
        default: "integration-test"
      vmImage:
        type: string
        default: "ubuntu-latest"
        required: false
      buildConfiguration:
        required: false
        type: string
        default: "Release"
      gitRepo:
        required: false
        type: string
        default: ""
      testProjects:
        required: true
        type: string
      dotnetVersion:
        required: false
        default: "7.*"
        type: string
      azureServicePrincipalClientId:
        required: false
        type: string
        default: ""
      azureTenantId:
        required: false
        type: string
        default: ""
jobs:
  test:
    runs-on: ${{ inputs.vmImage }}
    environment: ${{ inputs.environment }}
    name: .NET Test

    steps:
      - name: Checkout repository
        if: ${{ inputs.gitRepo != '' }}
        uses: actions/checkout@v5
        with:
          repository: ${{ inputs.gitRepo }}
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Default checkout
        uses: actions/checkout@v5

      - name: Setup dotnet ${{ inputs.dotnetVersion }}
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ inputs.dotnetVersion }}

      - name: Azure Login via OIDC
        if: ${{ inputs.azureServicePrincipalClientId != '' && inputs.azureTenantId != '' }}
        uses: azure/login@v2
        with:
          client-id: ${{ inputs.azureServicePrincipalClientId }}
          tenant-id: ${{ inputs.azureTenantId }}
          allow-no-subscriptions: true

      - name: Pull Docker test image
        run: docker image pull testcontainers/ryuk

      - name: Replace GitHub Packages feed token in NuGet.Config files
        shell: pwsh
        run: |
          $nugetFiles = Get-ChildItem -Path $env:GITHUB_WORKSPACE -Filter "NuGet.Config" -Recurse
          foreach ($file in $nugetFiles) {
              $content = Get-Content $file.FullName -Raw
              if ($content -match '<NorconsultDigital>') {
                  if ($content -match '<add key="ClearTextPassword" value="[^"]*"') {
                      $content = $content -replace '<add key="ClearTextPassword" value="[^"]*" />', "<add key=`"ClearTextPassword`" value=`"${{ secrets.GITHUB_TOKEN }}`" />"
                  }
                  Set-Content -Path $file.FullName -Value $content
              }
          }

      - name: Run tests with coverage and build verification
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Force -Path test-results
          $projects = Get-ChildItem -Path ${{ inputs.testProjects }} -Recurse -Include '*[T|t]ests.csproj'
          
          Write-Output "Found $($projects.Count) test projects"
          if ($projects.Count -eq 0) {
            Write-Output "No test projects found matching pattern '${{ inputs.testProjects }}'"
            exit 0
          }
          
          foreach ($project in $projects) {
            $project_name = [System.IO.Path]::GetFileNameWithoutExtension($project.FullName)
            Write-Output "Processing: $project_name"

            # Build the project explicitly
            dotnet build $project.FullName --configuration ${{ inputs.buildConfiguration }}
            if ($LASTEXITCODE -ne 0) {
              Write-Output "Build failed: $project_name"
              exit 1
            }

            # Test and collect coverage
            dotnet test $project.FullName `
              --configuration ${{ inputs.buildConfiguration }} `
              --no-build --no-restore `
              --logger "trx;LogFileName=$(Get-Location)/test-results/$project_name.trx" `
              --verbosity normal `
              --collect:"XPlat Code Coverage"
            if ($LASTEXITCODE -ne 0) {
              Write-Output "Tests failed: $project_name"
            }
          }


      - name: Check for TRX files
        id: present_test_summary_check
        if: always()
        run: |
          echo "=== TRX File Check ==="
          echo "Checking test-results directory..."

          if [ -d "test-results" ]; then
            echo "test-results directory exists"
            echo "Contents of test-results directory:"
            ls -la test-results/
            # Check specifically for TRX files
            if ls test-results/*.trx 1> /dev/null 2>&1; then
              echo "✅ TRX files found:"
              ls -1 test-results/*.trx
              echo "present_test_summary=true" >> $GITHUB_OUTPUT
            else
              echo "❌ No TRX files found in test-results directory"
              echo "present_test_summary=false" >> $GITHUB_OUTPUT
            fi
          else
            echo "❌ test-results directory does not exist"
            echo "present_test_summary=false" >> $GITHUB_OUTPUT
          fi

      - name: Report test results
        if: always() && steps.present_test_summary_check.outputs.present_test_summary == 'true'
        uses: phoenix-actions/test-reporting@v15
        with:
          name: .NET Tests
          path: test-results/*.trx
          reporter: dotnet-trx
          output-to: "step-summary"

      - name: Find coverage files
        id: find_coverage
        shell: pwsh
        run: |
          Write-Output "=== Looking for coverage files ==="
          # Look for common coverage file patterns
          $coverageFiles = @()
          $coverageFiles += Get-ChildItem -Recurse -Filter "coverage.cobertura.xml" -ErrorAction SilentlyContinue
          $coverageFiles += Get-ChildItem -Recurse -Filter "*.cobertura.xml" -ErrorAction SilentlyContinue
          $coverageFiles += Get-ChildItem -Recurse -Filter "coverage.xml" -ErrorAction SilentlyContinue
          $coverageFiles += Get-ChildItem -Recurse -Path "TestResults" -Filter "*.xml" -ErrorAction SilentlyContinue | Where-Object { $_.Name -like "*coverage*" }

          # Remove duplicates
          $coverageFiles = $coverageFiles | Sort-Object FullName | Get-Unique -AsString

          Write-Output "All XML files found:"
          Get-ChildItem -Recurse -Filter "*.xml" -ErrorAction SilentlyContinue | Select-Object FullName, Name | Format-Table -AutoSize

          if ($coverageFiles -and $coverageFiles.Count -gt 0) {
            Write-Output "`n✅ Found coverage files:"
            $coverageFiles | ForEach-Object { Write-Output $_.FullName }
            echo "has_coverage=true" >> $env:GITHUB_OUTPUT
          } else {
            Write-Output "`n❌ No coverage files found."
            echo "has_coverage=false" >> $env:GITHUB_OUTPUT
          }

      - name: Install ReportGenerator
        if: steps.find_coverage.outputs.has_coverage == 'true'
        run: dotnet tool install -g dotnet-reportgenerator-globaltool

      - name: Generate coverage reports
        if: steps.find_coverage.outputs.has_coverage == 'true'
        run: |
          echo "Looking for coverage files to process..."
          find . -name "*.xml" -path "*/TestResults/*" -type f -exec echo "Found: {}" \;
          reportgenerator -reports:**/*.xml -targetdir:coverage-report -reporttypes:Html;HtmlSummary;Badges;TextSummary

      - name: Upload coverage report artifact
        if: steps.find_coverage.outputs.has_coverage == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: coverage-report

