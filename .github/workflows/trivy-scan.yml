name: Trivy Security Scan

on:
  workflow_call:
    inputs:
      path:
        required: true
        type: string
        description: "Path to Terraform files"
      repository:
        required: false
        type: string
        default: "default"
        description: "Repository identifier for cache isolation"
      compare-branch:
        required: false
        type: string
        default: "main"
        description: "Branch to compare changes against"
      scan-type:
        required: false
        type: string
        default: "config"
        description: "Type of scan to perform"
      severity:
        required: false
        type: string
        default: "LOW,MEDIUM,HIGH,CRITICAL"
        description: "Severity levels to report"
      skip-files:
        required: false
        type: string
        default: ""
        description: "Comma-separated list of files to skip"

permissions:
  contents: read
  security-events: write
  actions: read

jobs:
  trivy-scan:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v5
        with:
          fetch-depth: 0
          # For PRs, fetch both base and head refs
          ref: ${{ github.event.pull_request.head.sha || github.sha }}

      # Determine changed files
      - name: Get changed Terraform files
        id: changed-files
        run: |
          set -e
          
          # Determine comparison base based on context
          if [ "${{ github.event_name }}" == "pull_request" ] || [ "${{ github.event_name }}" == "pull_request_target" ]; then
            # For PRs, compare against the base branch (target of the PR)
            COMPARE_REF="origin/${{ github.event.pull_request.base.ref }}"
            COMPARE_BRANCH="${{ github.event.pull_request.base.ref }}"
            echo "Running in PR context - comparing against base branch: ${COMPARE_BRANCH}"
            
            # Fetch base branch (handle fork PRs)
            if ! git fetch origin "${{ github.event.pull_request.base.ref }}" 2>/dev/null; then
              echo "Warning: Could not fetch base branch, using existing refs"
            fi
            
          elif [ "${{ github.event_name }}" == "merge_group" ]; then
            # For merge queue, compare against the base
            COMPARE_REF="${{ github.event.merge_group.base_ref }}"
            COMPARE_BRANCH="${{ github.event.merge_group.base_ref }}"
            echo "Running in merge queue context - comparing against: ${COMPARE_BRANCH}"
            
          else
            # For branch pushes
            CURRENT_BRANCH="${{ github.ref_name }}"
            COMPARE_BRANCH="${{ inputs.compare-branch }}"
            
            # If pushing to the compare branch itself, use the before commit to see changes
            if [ "${CURRENT_BRANCH}" == "${COMPARE_BRANCH}" ] && [ "${{ github.event.before }}" != "0000000000000000000000000000000000000000" ] && [ -n "${{ github.event.before }}" ]; then
              COMPARE_REF="${{ github.event.before }}"
              echo "Pushing to ${COMPARE_BRANCH} - comparing current commit against previous: ${COMPARE_REF}"
            else
              COMPARE_REF="origin/${COMPARE_BRANCH}"
              echo "Running in push context - comparing ${CURRENT_BRANCH} against: ${COMPARE_BRANCH}"
              
              # Fetch compare branch if it exists
              if ! git fetch origin "${COMPARE_BRANCH}" 2>/dev/null; then
                echo "Warning: Could not fetch compare branch '${COMPARE_BRANCH}', it may not exist"
                echo "has_changes=false" >> $GITHUB_OUTPUT
                exit 0
              fi
            fi
          fi
          
          # Get changed .tf files within the target path (repo-root relative)
          # Normalize path by removing leading ./
          NORMALIZED_PATH="${{ inputs.path }}"
          NORMALIZED_PATH="${NORMALIZED_PATH#./}"
          
          echo "Debug: Running git diff ${COMPARE_REF}...HEAD"
          echo "Debug: Input path: ${{ inputs.path }}"
          echo "Debug: Normalized path: ${NORMALIZED_PATH}"
          echo "Debug: Current directory: $(pwd)"
          
          # First, see all changed files
          ALL_CHANGED=$(git diff --name-only --diff-filter=d "${COMPARE_REF}...HEAD" || true)
          echo "Debug: All changed files:"
          echo "${ALL_CHANGED}"
          echo "---"
          
          # Filter for the path
          PATH_FILTERED=$(echo "${ALL_CHANGED}" | grep "^${NORMALIZED_PATH}/" || true)
          echo "Debug: Files matching path filter '${NORMALIZED_PATH}/':"
          echo "${PATH_FILTERED}"
          echo "---"
          
          # Then filter for .tf extension
          CHANGED_FILES_FULL=$(echo "${PATH_FILTERED}" | grep '\.tf$' || true)
          echo "Debug: Files matching .tf extension:"
          echo "${CHANGED_FILES_FULL}"
          echo "---"
          
          if [ -z "$CHANGED_FILES_FULL" ]; then
            echo "No .tf files changed in ${{ inputs.path }} compared to ${COMPARE_BRANCH}"
            echo "has_changes=false" >> $GITHUB_OUTPUT
          else
            echo "Changed files in ${{ inputs.path }} compared to ${COMPARE_BRANCH}:"
            echo "$CHANGED_FILES_FULL"
            echo "has_changes=true" >> $GITHUB_OUTPUT
            
            # Save changed files list (repo-root relative paths)
            echo "$CHANGED_FILES_FULL" > /tmp/changed_files.txt
          fi

      # Install Trivy and jq
      - name: Install Trivy and jq
        if: steps.changed-files.outputs.has_changes == 'true'
        run: |
          wget -qO - https://aquasecurity.github.io/trivy-repo/deb/public.key | sudo apt-key add -
          echo "deb https://aquasecurity.github.io/trivy-repo/deb $(lsb_release -sc) main" | sudo tee -a /etc/apt/sources.list.d/trivy.list
          sudo apt-get update
          sudo apt-get install trivy jq

      - name: Run Trivy Security Scan
        if: steps.changed-files.outputs.has_changes == 'true'
        continue-on-error: true
        run: |
          # Scan only changed files
          CHANGED_FILES=$(cat /tmp/changed_files.txt)
          
          # Build skip-files argument if provided
          SKIP_FILES_ARG=""
          if [ -n "${{ inputs.skip-files }}" ]; then
            SKIP_FILES_ARG="--skip-files ${{ inputs.skip-files }}"
          fi
          
          # Create temp directory for individual SARIF files
          SARIF_DIR="${{ inputs.path }}/trivy-sarif-temp"
          mkdir -p "$SARIF_DIR"
          
          # Initialize output files
          echo "Scanning changed Terraform files:" > ${{ inputs.path }}/trivy-output.txt
          
          # Scan each changed file and generate both SARIF and table output
          counter=0
          echo "$CHANGED_FILES" | while IFS= read -r file; do
            if [ -n "$file" ]; then
              counter=$((counter + 1))
              
              # Generate individual SARIF output (use > not >>)
              trivy config \
                --format sarif \
                --severity ${{ inputs.severity }} \
                $SKIP_FILES_ARG \
                --exit-code 0 \
                "$file" > "${SARIF_DIR}/trivy-${counter}.sarif" 2>/dev/null || true
              
              # Generate table output
              echo "" >> ${{ inputs.path }}/trivy-output.txt
              echo "=== $file ===" >> ${{ inputs.path }}/trivy-output.txt
              trivy config \
                --format table \
                --severity ${{ inputs.severity }} \
                $SKIP_FILES_ARG \
                --exit-code 0 \
                "$file" >> ${{ inputs.path }}/trivy-output.txt 2>&1 || true
            fi
          done
          
          # Merge all SARIF files into one valid SARIF document
          if ls "${SARIF_DIR}"/*.sarif 1> /dev/null 2>&1; then
            # Extract all results from individual SARIF files and merge them
            jq -s '{
              "version": "2.1.0",
              "$schema": "https://raw.githubusercontent.com/oasis-tcs/sarif-spec/master/Schemata/sarif-schema-2.1.0.json",
              "runs": [{
                "tool": .[0].runs[0].tool,
                "results": [.[] | .runs[0].results[]] | flatten
              }]
            }' "${SARIF_DIR}"/*.sarif > ${{ inputs.path }}/trivy-results.sarif
          else
            # Create empty SARIF if no files were scanned
            echo '{"version":"2.1.0","$schema":"https://raw.githubusercontent.com/oasis-tcs/sarif-spec/master/Schemata/sarif-schema-2.1.0.json","runs":[{"tool":{"driver":{"name":"Trivy","informationUri":"https://github.com/aquasecurity/trivy"}},"results":[]}]}' > ${{ inputs.path }}/trivy-results.sarif
          fi
          
          # Clean up temp directory
          rm -rf "${SARIF_DIR}"

      # Upload Trivy SARIF results to GitHub Security
      - name: Upload Trivy SARIF results
        uses: github/codeql-action/upload-sarif@v4
        if: always() && steps.changed-files.outputs.has_changes == 'true' && hashFiles(format('{0}/trivy-results.sarif', inputs.path)) != ''
        with:
          sarif_file: ${{ inputs.path }}/trivy-results.sarif
          category: trivy

      # Create output for no changes case
      - name: Create no changes output
        if: steps.changed-files.outputs.has_changes != 'true'
        run: |
          mkdir -p ${{ inputs.path }}
          echo "No Terraform files changed - skipping Trivy scan" > ${{ inputs.path }}/trivy-output.txt
          # Create empty SARIF file for Code Scanning
          echo '{"version":"2.1.0","$schema":"https://raw.githubusercontent.com/oasis-tcs/sarif-spec/master/Schemata/sarif-schema-2.1.0.json","runs":[{"tool":{"driver":{"name":"Trivy","informationUri":"https://github.com/aquasecurity/trivy"}},"results":[]}]}' > ${{ inputs.path }}/trivy-results.sarif

      # Upload Trivy output as artifact
      - name: Upload Trivy output
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: trivy-output
          path: ${{ inputs.path }}/trivy-output.txt
          retention-days: 5

      # Publish Trivy results to task summary
      - name: Publish Trivy Results to Task Summary
        if: always()
        run: |
          if [ -f trivy-output.txt ]; then
            TRIVY_OUTPUT=$(cat trivy-output.txt)
            
            {
              echo "## Trivy Security Scan Results"
              echo "\`${{ inputs.path }}\`"
              echo "<details><summary>Click to expand</summary>"
              echo ""
              echo '```'
              echo "${TRIVY_OUTPUT}"
              echo '```'
              echo "</details>"
              echo ""
            } >> "${GITHUB_STEP_SUMMARY}"
          fi
        working-directory: ${{ inputs.path }}
