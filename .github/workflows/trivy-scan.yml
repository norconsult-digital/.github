name: Trivy Security Scan

on:
  workflow_call:
    inputs:
      path:
        required: true
        type: string
        description: "Path to Terraform files"
      repository:
        required: false
        type: string
        default: "default"
        description: "Repository identifier for cache isolation"
      compare-branch:
        required: false
        type: string
        default: "main"
        description: "Branch to compare changes against"
      scan-type:
        required: false
        type: string
        default: "config"
        description: "Type of scan to perform"
      severity:
        required: false
        type: string
        default: "LOW,MEDIUM,HIGH,CRITICAL"
        description: "Severity levels to report"
      skip-files:
        required: false
        type: string
        default: ""
        description: "Comma-separated list of files to skip"

permissions:
  contents: read
  security-events: write

jobs:
  trivy-scan:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v5
        with:
          fetch-depth: 0
          # For PRs, fetch both base and head refs
          ref: ${{ github.event.pull_request.head.sha || github.sha }}

      # Determine changed files
      - name: Get changed Terraform files
        id: changed-files
        run: |
          set -e
          
          # Determine comparison base based on context
          if [ "${{ github.event_name }}" == "pull_request" ] || [ "${{ github.event_name }}" == "pull_request_target" ]; then
            # For PRs, compare against the base branch (target of the PR)
            COMPARE_REF="origin/${{ github.event.pull_request.base.ref }}"
            COMPARE_BRANCH="${{ github.event.pull_request.base.ref }}"
            echo "Running in PR context - comparing against base branch: ${COMPARE_BRANCH}"
            
            # Fetch base branch (handle fork PRs)
            if ! git fetch origin "${{ github.event.pull_request.base.ref }}" 2>/dev/null; then
              echo "Warning: Could not fetch base branch, using existing refs"
            fi
            
          elif [ "${{ github.event_name }}" == "merge_group" ]; then
            # For merge queue, compare against the base
            COMPARE_REF="${{ github.event.merge_group.base_ref }}"
            COMPARE_BRANCH="${{ github.event.merge_group.base_ref }}"
            echo "Running in merge queue context - comparing against: ${COMPARE_BRANCH}"
            
          else
            # For branch pushes
            CURRENT_BRANCH="${{ github.ref_name }}"
            COMPARE_BRANCH="${{ inputs.compare-branch }}"
            
            # If pushing to the compare branch itself, use the before commit to see changes
            if [ "${CURRENT_BRANCH}" == "${COMPARE_BRANCH}" ] && [ "${{ github.event.before }}" != "0000000000000000000000000000000000000000" ] && [ -n "${{ github.event.before }}" ]; then
              COMPARE_REF="${{ github.event.before }}"
              echo "Pushing to ${COMPARE_BRANCH} - comparing current commit against previous: ${COMPARE_REF}"
            else
              COMPARE_REF="origin/${COMPARE_BRANCH}"
              echo "Running in push context - comparing ${CURRENT_BRANCH} against: ${COMPARE_BRANCH}"
              
              # Fetch compare branch if it exists
              if ! git fetch origin "${COMPARE_BRANCH}" 2>/dev/null; then
                echo "Warning: Could not fetch compare branch '${COMPARE_BRANCH}', it may not exist"
                echo "has_changes=false" >> $GITHUB_OUTPUT
                exit 0
              fi
            fi
          fi
          
          # Get changed .tf files within the target path (repo-root relative)
          # Normalize path by removing leading ./
          NORMALIZED_PATH="${{ inputs.path }}"
          NORMALIZED_PATH="${NORMALIZED_PATH#./}"
          
          echo "Debug: Running git diff ${COMPARE_REF}...HEAD"
          echo "Debug: Input path: ${{ inputs.path }}"
          echo "Debug: Normalized path: ${NORMALIZED_PATH}"
          echo "Debug: Current directory: $(pwd)"
          
          # First, see all changed files
          ALL_CHANGED=$(git diff --name-only --diff-filter=d "${COMPARE_REF}...HEAD" || true)
          echo "Debug: All changed files:"
          echo "${ALL_CHANGED}"
          echo "---"
          
          # Filter for the path
          PATH_FILTERED=$(echo "${ALL_CHANGED}" | grep "^${NORMALIZED_PATH}/" || true)
          echo "Debug: Files matching path filter '${NORMALIZED_PATH}/':"
          echo "${PATH_FILTERED}"
          echo "---"
          
          # Then filter for .tf extension
          CHANGED_FILES_FULL=$(echo "${PATH_FILTERED}" | grep '\.tf$' || true)
          echo "Debug: Files matching .tf extension:"
          echo "${CHANGED_FILES_FULL}"
          echo "---"
          
          if [ -z "$CHANGED_FILES_FULL" ]; then
            echo "No .tf files changed in ${{ inputs.path }} compared to ${COMPARE_BRANCH}"
            echo "has_changes=false" >> $GITHUB_OUTPUT
          else
            echo "Changed files in ${{ inputs.path }} compared to ${COMPARE_BRANCH}:"
            echo "$CHANGED_FILES_FULL"
            echo "has_changes=true" >> $GITHUB_OUTPUT
            
            # Save changed files list
            echo "$CHANGED_FILES_FULL" > /tmp/changed_files.txt
          fi

      - name: Terraform Security Scan (Trivy) - SARIF
        if: steps.changed-files.outputs.has_changes == 'true'
        uses: aquasecurity/trivy-action@0.33.1
        continue-on-error: true
        with:
          scan-type: ${{ inputs.scan-type }}
          scan-ref: ${{ inputs.path }}
          format: "sarif"
          output: "${{ inputs.path }}/trivy-results.sarif"
          exit-code: "0"
          ignore-unfixed: "false"
          severity: ${{ inputs.severity }}
          skip-files: ${{ inputs.skip-files }}

      # Upload Trivy SARIF results to GitHub Security
      - name: Upload Trivy SARIF results
        uses: github/codeql-action/upload-sarif@v4
        if: always() && steps.changed-files.outputs.has_changes == 'true' && hashFiles(format('{0}/trivy-results.sarif', inputs.path)) != ''
        with:
          sarif_file: ${{ inputs.path }}/trivy-results.sarif
          category: trivy

      # Run Trivy for human-readable output
      - name: Run Trivy for output
        if: steps.changed-files.outputs.has_changes == 'true'
        uses: aquasecurity/trivy-action@0.33.1
        continue-on-error: true
        with:
          scan-type: ${{ inputs.scan-type }}
          scan-ref: ${{ inputs.path }}
          format: "table"
          output: "${{ inputs.path }}/trivy-output.txt"
          exit-code: "0"
          ignore-unfixed: "false"
          severity: ${{ inputs.severity }}
          skip-files: ${{ inputs.skip-files }}

      # Create output for no changes case
      - name: Create no changes output
        if: steps.changed-files.outputs.has_changes != 'true'
        run: |
          mkdir -p ${{ inputs.path }}
          echo "No Terraform files changed - skipping Trivy scan" > ${{ inputs.path }}/trivy-output.txt

      # Upload Trivy output as artifact
      - name: Upload Trivy output
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: trivy-output
          path: ${{ inputs.path }}/trivy-output.txt
          retention-days: 5

      # Publish Trivy results to task summary
      - name: Publish Trivy Results to Task Summary
        if: always()
        run: |
          if [ -f trivy-output.txt ]; then
            TRIVY_OUTPUT=$(cat trivy-output.txt)
            
            {
              echo "## Trivy Security Scan Results"
              echo "\`${{ inputs.path }}\`"
              echo "<details><summary>Click to expand</summary>"
              echo ""
              echo '```'
              echo "${TRIVY_OUTPUT}"
              echo '```'
              echo "</details>"
              echo ""
            } >> "${GITHUB_STEP_SUMMARY}"
          fi
        working-directory: ${{ inputs.path }}
