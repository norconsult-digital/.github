name: "dotnet version checker"

on:
  workflow_call:
    inputs:
      support:
        description: "The support level to target (STS, LTS, or Preview)."
        type: string
        required: true
        default: "STS"

jobs:
  version-sweep:
    runs-on: ubuntu-latest
    permissions:
      issues: write
      contents: read
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup .NET 9 SDK
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 9.0.x
          
      - name: .NET version sweeper
        id: dotnet-version-sweeper
        uses: dotnet/versionsweeper@v4.3
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          owner: ${{ github.repository_owner }}
          name: ${{ github.repository }}
          branch: ${{ github.ref }}

      - name: Create upgrade issues
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Check for LTS versions expiring within 90 days
          current_date=$(date +%s)
          warning_date=$((current_date + 90*24*60*60))
          
          # Check .NET 6 projects
          net6_expire=$(date -d "2024-11-12" +%s)
          if [[ $net6_expire -le $warning_date ]]; then
            net6_projects=$(find . -name "*.csproj" -exec grep -l "net6.0" {} \; 2>/dev/null || true)
            if [[ -n "$net6_projects" ]]; then
              echo "## 🚨 .NET 6 LTS Expiring" > lts_issue.txt
              echo "**Expires:** November 12, 2024" >> lts_issue.txt
              echo "### Projects:" >> lts_issue.txt
              echo "$net6_projects" | sed 's|^\./||; s/^/- /' >> lts_issue.txt
              echo "**Action:** Update to .NET 8 LTS" >> lts_issue.txt
              
              gh issue create \
                --title "⚠️ .NET 6 LTS Expiring - $(date +%Y-%m-%d)" \
                --body-file lts_issue.txt \
                --label "critical"
            fi
          fi

          # Handle standard upgrades - SIMPLIFIED VERSION
          upgradeProjects='${{ steps.dotnet-version-sweeper.outputs.upgrade-projects }}'
          
          if [[ -n "$upgradeProjects" && "$upgradeProjects" != "null" && "$upgradeProjects" != "[]" ]]; then
            # Set target based on input
            TARGET="net9.0"
            case "${{ inputs.support }}" in
              "LTS") TARGET="net8.0" ;;
              "Preview") TARGET="net10.0" ;;
            esac
            
            # Create simple upgrade issue
            echo "## 📋 .NET Upgrade Report" > upgrade.txt
            echo "**Target:** $TARGET" >> upgrade.txt
            echo "### Projects:" >> upgrade.txt
            
            # Simple approach - just list all projects from versionsweeper
            echo "$upgradeProjects" | jq -r '.[]' | while read -r project; do
              name=$(basename "$project")
              echo "- [ ] $name" >> upgrade.txt
            done 2>/dev/null || echo "- No projects found" >> upgrade.txt
            
            echo "**Steps:** Update \`<TargetFramework>\` to \`$TARGET\`" >> upgrade.txt
            
            gh issue create \
              --title "Weekly .NET Upgrade - $(date +%Y-%m-%d)" \
              --body-file upgrade.txt \
              --label "enhancement"
              
            echo "✅ Created upgrade issue"
          fi

          echo "✅ workflow completed"
