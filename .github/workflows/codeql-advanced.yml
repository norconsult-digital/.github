name: CodeQL Advanced Template

on:
  workflow_call:
    inputs:
      path:
        type: string
        required: true
      runner:
        type: string
        default: 'ubuntu-latest'
      language:
        type: string
        required: true
      build-mode:
        type: string
        required: true

jobs:
  analyze:
    name: Analyze (${{ inputs.language }})
    runs-on:
      labels: ${{ inputs.runner }}
    timeout-minutes: ${{ (inputs.language == 'swift' && 120) || 360 }}
    permissions:
      security-events: write
      packages: read
      actions: read
      contents: read
      
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          sparse-checkout: ${{ inputs.path }}

      - name: Initialize CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: ${{ inputs.language }}
          build-mode: ${{ inputs.build-mode }}

      - if: inputs.build-mode == 'manual'
        shell: bash
        run: |
          echo 'If you are using a "manual" build mode for one or more of the' \
            'languages you are analyzing, replace this with the commands to build' \
            'your code, for example:'
          echo '  make bootstrap'
          echo '  make release'
          exit 1

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v3
        with:
          category: "/path:${{ inputs.path }}"
